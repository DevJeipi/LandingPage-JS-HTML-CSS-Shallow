<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="shortcut icon"
      href="../assets/favicon/favicon.ico"
      type="image/x-icon"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/2.6.0/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/2.6.0/uicons-brands/css/uicons-brands.css"
    />
    <link rel="stylesheet" href="../assets/css/pages/form/index.css" />
    <!-- Google Tag Manager -->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
          "gtm.start": new Date().getTime(),
          event: "gtm.js",
        });
        var f = d.getElementsByTagName(s)[0],
          j = d.createElement(s),
          dl = l != "dataLayer" ? "&l=" + l : "";
        j.async = true;
        j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
        f.parentNode.insertBefore(j, f);
      })(window, document, "script", "dataLayer", "GTM-NS2LVTQB");
    </script>
    <!-- End Google Tag Manager -->
    <title>Formulário de inscrição | Shallow Beachwear</title>
  </head>

  <body>
    <!-- Google Tag Manager (noscript) -->
    <noscript
      ><iframe
        src="https://www.googletagmanager.com/ns.html?id=GTM-NS2LVTQB"
        height="0"
        width="0"
        style="display: none; visibility: hidden"
      ></iframe
    ></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <section class="form">
      <div class="centro elementFlex">
        <form name="info" class="info-form elementFlex" id="info-form">
          <div class="image">
            <img
              src="../assets/images/logo-shallow-allwhite-resized.png"
              alt="Logo Shallow Beachwear"
            />
          </div>
          <h1>Preencha os campos abaixo para fazer sua inscrição:</h1>
          <div class="field">
            <div class="control">
              <input
                required
                type="text"
                name="name"
                class="input"
                placeholder="Seu nome completo aqui*"
                minlength="2"
                maxlength="100"
              />
              <span class="icon"><i class="fi fi-rr-user"></i></span>
            </div>
          </div>
          <div class="field">
            <div class="control">
              <input
                required
                type="email"
                name="email"
                class="input"
                placeholder="Seu melhor e-mail*"
                maxlength="255"
              />
              <span class="icon"><i class="fi fi-rr-at"></i></span>
            </div>
          </div>
          <div class="field">
            <div class="control elementFlex phone-field">
              <select required name="country-code" class="country-code">
                <option value="" disabled selected>DDD País</option>
                <!-- América -->
                <option value="+54">+54 (Argentina)</option>
                <option value="+55">+55 (Brasil)</option>
                <option value="+53">+53 (Cuba)</option>
                <option value="+506">+506 (Costa Rica)</option>
                <option value="+503">+503 (El Salvador)</option>
                <option value="+502">+502 (Guatemala)</option>
                <option value="+504">+504 (Honduras)</option>
                <option value="+505">+505 (Nicarágua)</option>
                <option value="+507">+507 (Panamá)</option>
                <option value="+51">+51 (Peru)</option>
                <option value="+59">+59 (Caribe - genérico)</option>
                <option value="+1">+1 (EUA/Canadá)</option>
                <option value="+52">+52 (México)</option>
                <option value="+58">+58 (Venezuela)</option>
                <option value="+57">+57 (Colômbia)</option>
                <option value="+56">+56 (Chile)</option>
                <!-- Europa -->
                <option value="+34">+34 (Espanha)</option>
                <option value="+33">+33 (França)</option>
                <option value="+39">+39 (Itália)</option>
                <option value="+351">+351 (Portugal)</option>
                <option value="+44">+44 (Reino Unido)</option>
                <option value="+49">+49 (Alemanha)</option>
              </select>
              <input
                required
                type="tel"
                name="number"
                class="input phone-number"
                placeholder="DDD Estadual + Número*"
                pattern="[0-9\s\(\)\-]{8,15}"
                title="Digite apenas números, parênteses, hífens ou espaços"
              />
            </div>
          </div>
          <div class="field">
            <div class="control elementFlex">
              <button type="submit" class="btn" id="submit-btn">
                Concluir
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>
    <div id="toast-container" class="toast-container"></div>
  </body>
  <script>
    function showToast(message, type = "success") {
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.innerText = message;

      document.getElementById("toast-container").appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    // Função para sanitizar strings
    function sanitizeString(str) {
      return str
        .trim()
        .normalize("NFKC") // Normaliza caracteres Unicode
        .replace(/\s+/g, " "); // Remove espaços extras
    }

    // Função para validar email
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email.trim().toLowerCase());
    }

    // Função para validar e limpar telefone
    function cleanPhone(phone) {
      // Remove tudo que não é dígito
      return phone.replace(/\D/g, "");
    }

    // Função para validar telefone brasileiro
    function isValidBrazilianPhone(phone) {
      const cleaned = cleanPhone(phone);
      // Deve ter 10 ou 11 dígitos (DDD + número)
      return cleaned.length >= 10 && cleaned.length <= 11;
    }

    document
      .getElementById("info-form")
      .addEventListener("submit", async function (e) {
        e.preventDefault();

        const form = e.target;
        const submitBtn = document.getElementById("submit-btn");
        const originalBtnText = submitBtn.innerHTML;

        // Desabilitar botão e mostrar loading
        submitBtn.disabled = true;
        submitBtn.innerHTML =
          '<span class="spinner" style="margin-right:8px;vertical-align:middle;width:18px;height:18px;display:inline-block;border:2px solid #fff;border-top:2px solid #e91e63;border-radius:50%;animation:spin 1s linear infinite;"></span>Enviando...';

        try {
          // Coletar e sanitizar dados
          const nomeRaw = form.name.value;
          const emailRaw = form.email.value;
          const dddPais = form["country-code"].value.trim();
          const numeroRaw = form.number.value;

          // Sanitizar dados
          const nome = sanitizeString(nomeRaw);
          const email = emailRaw.trim().toLowerCase();
          const numeroLimpo = cleanPhone(numeroRaw);
          const telefone = dddPais + numeroLimpo;

          console.log("Dados coletados:", { nome, email, telefone });

          // Validações no frontend
          const errors = [];

          if (!nome || nome.length < 2) {
            errors.push("Nome deve ter pelo menos 2 caracteres.");
          }

          if (!isValidEmail(email)) {
            errors.push("E-mail inválido. Verifique e tente novamente.");
          }

          if (!dddPais) {
            errors.push("Selecione o código do país.");
          }

          // Para números brasileiros, fazer validação específica
          if (dddPais === "+55" && !isValidBrazilianPhone(numeroRaw)) {
            errors.push(
              "Número de telefone brasileiro inválido. Deve ter 10 ou 11 dígitos (DDD + número)."
            );
          } else if (dddPais !== "+55" && numeroLimpo.length < 8) {
            errors.push("Número de telefone muito curto.");
          }

          if (errors.length > 0) {
            showToast(errors[0], "error");
            return;
          }

          console.log("Enviando dados:", { nome, email, telefone });

          // Fazer requisição para o backend
          const resposta = await fetch(
            "https://api-shallow.onrender.com/api/enviar",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json; charset=utf-8",
              },
              body: JSON.stringify({ nome, email, telefone }),
            }
          );

          const resultado = await resposta.json();

          if (resposta.ok) {
            form.reset();
            showToast("Inscrição realizada com sucesso!", "success");
            setTimeout(() => {
              window.location.href = "../obrigado";
            }, 1500);
          } else {
            console.error("Erro do servidor:", resultado);

            let mensagemErro =
              "Erro ao enviar os dados. Tente novamente mais tarde.";

            if (resultado.detalhes && Array.isArray(resultado.detalhes)) {
              mensagemErro = resultado.detalhes[0];
            } else if (resultado.erro) {
              mensagemErro = resultado.erro;
            }

            showToast(mensagemErro, "error");
          }
        } catch (err) {
          console.error("Erro na requisição:", err);
          showToast(
            "Erro de conexão com o servidor. Verifique sua internet ou tente mais tarde.",
            "error"
          );
        } finally {
          // Restaurar botão
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });

    // Spinner animation CSS
    const style = document.createElement("style");
    style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }`;
    document.head.appendChild(style);

    // Máscara para telefone brasileiro
    document
      .querySelector('input[name="number"]')
      .addEventListener("input", function (e) {
        const countryCode = document.querySelector(
          'select[name="country-code"]'
        ).value;

        if (countryCode === "+55") {
          let value = e.target.value.replace(/\D/g, "");

          if (value.length <= 2) {
            value = value.replace(/(\d{0,2})/, "($1");
          } else if (value.length <= 6) {
            value = value.replace(/(\d{2})(\d{0,4})/, "($1) $2");
          } else if (value.length <= 10) {
            value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, "($1) $2-$3");
          } else {
            value = value.replace(/(\d{2})(\d{5})(\d{0,4})/, "($1) $2-$3");
          }

          e.target.value = value;
        }
      });
  </script>
</html>
